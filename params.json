{
  "name": "Gtexv6prarevariation",
  "tagline": "Repository to reproduce analyses from the GTEx V6P Rare Variation Manuscript",
  "body": "# GTExV6PRareVariation\r\nRepository to reproduce analyses from the GTEx V6P Rare Variation Manuscript\r\n\r\n# To run the code\r\n## Download required files\r\nDownload from \\<website - coming soon\\>: <br>\r\n* processed data directory (referred to below as \\<processed_data\\>)\r\n\r\nDownload from http://www.gtexportal.org/home/datasets: <br>\r\n* `gencode.v19.genes.v6p_model.patched_contigs.gtf.gz`\r\n* `GTEx_Analysis_v6p_RNA-seq_RNA-SeQCv1.1.8_gene_reads.gct.gz` (gunzip it)\r\n* `GTEx_Analysis_v6p_RNA-seq_RNA-SeQCv1.1.8_gene_rpkm.gct.gz` (gunzip it)\r\n* `GTEx_Data_V6_Annotations_SampleAttributesDS.txt`\r\n* `GTEx_Analysis_2015-01-12_Annotations_SubjectPhenotypesDS.txt`\r\n* the covariates used during eQTL discovery\r\n\r\nDownload from Gencode (http://www.gencodegenes.org/releases/19.html; Comprehensive gene annotation gtf):\r\n* `gencode.v19.annotation.gtf.gz` (gunzip it)\r\n\r\nDownload from dbGaP: <br>\r\n(It is possible some of the file names may be different in the final release.)\r\n* `GTEx_Analysis_2015-01-12_WholeGenomeSeq_148Indiv_GATK_HaplotypeCaller.vcf.gz`\r\n* ASE files\r\n\r\nDownload from http://krishna.gs.washington.edu/download/CADD/v1.2/:\r\n* `whole_genome_SNVs.tsv.gz`\r\n* `whole_genome_SNVs.tsv.gz.tbi`\r\n* `whole_genome_SNVs_inclAnno.tsv.gz`\r\n* `whole_genome_SNVs_inclAnno.tsv.gz.tbi`\r\n\r\nDownload from ftp://ftp-trace.ncbi.nih.gov/1000genomes/ftp/release/20130502/:\r\n* `ALL.chr*.phase3_shapeit2_mvncall_integrated_v5a.20130502.genotypes.vcf.gz`\r\n\r\nDownload from http://compbio.mit.edu/encode-motifs/:\r\n* `matches.txt.gz`\r\n\r\nDownload Epigenomics Roadmap files from http://www.broadinstitute.org/~meuleman/reg2map/HoneyBadger2_release/DNase/p2/:\r\n* `prom/BED_files_per_sample/regions_prom_E*.bed`\r\n* `enh/BED_files_per_sample/regions_enh_E*.bed`\r\n* `dyadic/BED_files_per_sample/regions_dyadic_E*.bed`\r\n\r\nDownload ExAC constraint data from ftp://ftp.broadinstitute.org/pub/ExAC_release/release0.3/functional_gene_constraint/:\r\n* `forweb_cleaned_exac_r03_march16_z_data_pLI.txt`\r\n\r\nOther files: <br>\r\n* `gtex.lumpy.gs.svscore.low_conf.vcf.gz` (Obtained directly from the Hall Lab.)\r\n\r\n## Setup\r\nThe code relies on an assumed directory structure.\r\nEverything is under an upper level directory.\r\nIf you are using the processed files available online, set this upper-level directory to be the path to \\<processed_data\\>. <br>\r\nOtherwise, set this to be any path where you want scripts to output.\r\n\r\nEither run or add the following to your .bashrc (omit trailing slashes for all directories): <br>\r\n```\r\nexport RAREVARDIR=<the path to the upper-level directory>\r\nexport CADD_DIR=<the path to the CADD files>\r\nexport KG_DIR=<the path to the 1000 genomes files>\r\nexport ENCODE_MOTIF_DIR=<the path to matches.txt.gz (excluding the file name)>\r\nexport ER_DIR=<the path to the Epigenomics Roadmap directory (sub directories are prom, enh, and dyadic)>\r\nexport EXAC_DIR=<the path to forweb_cleaned_exac_r03_march16_z_data_pLI.txt (excluding the file name)>\r\n```\r\n\r\nIf you are going to run everything from scratch, first make the directories that are assumed to exist. <br>\r\nYou can skip this step if you will use the processed data files downloaded from \\<website - coming soon\\>. <br>\r\n```\r\nmkdir ${RAREVARDIR}/logs\r\nmkdir ${RAREVARDIR}/preprocessing\r\nmkdir ${RAREVARDIR}/preprocessing/PEER\r\nmkdir ${RAREVARDIR}/reference\r\nmkdir ${RAREVARDIR}/data\r\nmkdir ${RAREVARDIR}/data/medz\r\nmkdir ${RAREVARDIR}/data/singlez\r\nmkdir ${RAREVARDIR}/data/metasoft\r\n```\r\n\r\nThese directories are required to hold the results of scripts for which we do not provide processed data.\r\n```\r\nmkdir ${RAREVARDIR}/paper_figures\r\nmkdir ${RAREVARDIR}/features\r\nmkdir ${RAREVARDIR}/features/variantBeds\r\nmkdir ${RAREVARDIR}/features/annotations\r\nmkdir ${RAREVARDIR}/features/annotations/ACMG\r\nmkdir ${RAREVARDIR}/features/annotations/ClinVar\r\nmkdir ${RAREVARDIR}/features/annotations/GWAS\r\nmkdir ${RAREVARDIR}/features/annotations/OMIM\r\nmkdir ${RAREVARDIR}/features/annotations/Orphanet\r\nmkdir ${RAREVARDIR}/features/annotations/Other\r\n```\r\n\r\nThen you can run the code below. <br>\r\nSome of the steps reproduce processed files available on \\<website - coming soon\\> and are marked as such.\r\n\r\n# Pipeline\r\n## Expression data correction and normalization\r\nGenerates processed data that can be downloaded from \\<website - coming soon\\>. <br>\r\n\r\n#### Generate rpkm and read count matrices from GTEx V6P combined file\r\n```\r\ncat \\<path to downloaded file\\>/GTEx_Data_V6_Annotations_SampleAttributesDS.txt | \\\r\n\tcut -f1,14 | sed 's/ - /_/' | sed 's/ /_/g' | sed 's/(//' | sed 's/)//' | sed 's/c-1/c1/' | grep -v NA12878 > \\\r\n\t${RAREVARDIR}/preprocessing/gtex_2015-01-12_samples_tissues.txt\r\n\r\npython preprocessing/split_by_tissues.py \\\r\n    --GTEX \\<path to downloaded file\\>/GTEx_Analysis_v6p_RNA-seq_RNA-SeQCv1.1.8_gene_rpkm.gct \\\r\n    --SAMPLE ${RAREVARDIR}/preprocessing/gtex_2015-01-12_samples_tissues.txt \\\r\n    --OUT ${RAREVARDIR}/preprocessing/PEER \\\r\n    --END .rpkm.txt <br>\r\n\r\npython preprocessing/split_by_tissues.py \\\r\n    --GTEX \\<path to downloaded file\\>/GTEx_Analysis_v6p_RNA-seq_RNA-SeQCv1.1.8_gene_reads.gct \\\r\n    --SAMPLE ${RAREVARDIR}/preprocessing/gtex_2015-1-12_samples_tissues.txt \\\r\n    --OUT ${RAREVARDIR}/preprocessing/PEER \\\r\n    --END .reads.txt\r\n```\r\n\r\n#### Run bash scripts to generate PEER corrected data (includes non-EAs) with covariates removed\r\n(Uses multiple cores. Currently set to 10 cores. Can be altered by changing the number of cores <br> \r\nspecified by `parallel --jobs 10` in the scripts `preprocessing/PEER/calc.PEER.factors.all.tissues.sh` and <br>\r\n`preprocessing/PEER/calc.residuals.sh`) <br>\r\n```\r\nbash preprocessing/PEER/PEER.pipeline.sh\r\n```\r\n\r\n#### Make list of individuals and tissues\r\n```\r\nbash preprocessing/get_tissue_by_individual.sh\r\n```\r\n\r\n#### Make flat files from raw RPKMs and PEER-corrected data for all tissues and individuals\r\n```\r\npython preprocessing/gather_filter_normalized_expression.py\r\npython preprocessing/gather_filter_rpkm.py\r\n```\r\n\r\n#### Make list of expressed genes\r\n```\r\ncat preprocessing/PEER/*peer.ztrans.txt | cut -f1 | sort | uniq | \\\r\ngrep -v Id > preprocessing/gtex.expressed.genes.txt\r\n```\r\n\r\n#### Make summary statistics for expressed genes\r\n(Uses multiple cores. Can set the number at the top of the script. Currently set to 10 cores.)\r\n```\r\nRscript preprocessing/rpkm.expression.analysis.R\r\n```\r\n\r\n## Preparing reference files used later\r\nGenerates processed data that can be downloaded from \\<website - coming soon\\>. <br>\r\n\r\nCopy or move the GTEx annotation file (`gencode.v19.genes.v6p_model.patched_contigs.gtf.gz`) to `${RAREVARDIR}/reference`.\r\n```\r\nbash preprocessing/process.reference.files.sh \\<path to\\>/gencode.v19.genes.v6p_model.patched_contigs.gtf.gz \\<path to\\>/gencode.v19.annotation.gtf\r\n```\r\n(relies on `pad.gtf.exons.py`, `gtf2TSS.sh`, and `gtf2genebed.sh`)\r\n\r\n\r\n## Outlier calling\r\nGenerates processed data that can be downloaded from \\<website - coming soon\\>. <br>\r\n\r\n#### Call multi-tissue outliers\r\n(Uses multiple cores. Can set the number at the top of the script.)\r\n```\r\nRscript call_outliers/call_outliers_medz.R\r\n```\r\n\r\n#### Call single-tissue outliers\r\n```\r\npython call_outliers/call_outliers_single_tissue.py\r\n```\r\n\r\n#### Compare single-tissue and multi-tissue outliers as well as get stats on each\r\n```\r\nRscript call_outliers/compare_single_multi_outliers.R\r\n```\r\n\r\n#### Run replication for single-tissue and multi-tissue outliers\r\n(The multi-tissue replication uses multiple cores.)\r\n```\r\nRscript call_outliers/multi_tissue_replication.R\r\nRscript call_outliers/single_tissue_replication.R\r\n```\r\n\r\n## Feature generation\r\n\r\n#### Processing VCFs into bed files for each individual\r\n```\r\nbash feature_construction/vcf2bedfiles.sh \r\n\t \\<path to \\>/GTEx_Analysis_2015-01-12_WholeGenomeSeq_148Indiv_GATK_HaplotypeCaller.vcf.gz \r\n\t \\<path to\\>/gtex.lumpy.gs.svscore.low_conf.vcf.gz\r\n```\r\n(relies on :\r\n* `vcf2bedfiles_helper_processVCF.sh`\r\n* `vcf2bedfiles_helper_processVCF_SV.sh`\r\n* `vcf2bedfiles_helper_processVCFtoolsOutput.sh`\r\n* `vcf2bedfiles_helper_processVCFtoolsOutput_CNV.sh`\r\n* `compileCADDscores.sh`\r\n* `extractCADDscores_ekt.py`)\r\n\r\n#### Extract features to be combined with the individual bed files\r\n```\r\nbash feature_construction/extract.1kg.AF.sh\r\n```\r\n(uses multiple cores; relies on `process.1kg.AF.py`)\r\n```\r\nbash feature_construction/subset.CADD.features.sh\r\n\r\nbash feature_construction/TFBS_pipeline.sh\r\n```\r\n(relies on `pouya.raw.summary.py`)\r\n```\r\nbash feature_construction/ER_pipeline.sh\r\n```\r\n\r\n#### Add extracted features to individual bed files\r\n```\r\nbash run_add_features_variant_beds.sh\r\n```\r\n**Important:** Make sure to use bedtools version 2.26.0 or later.\r\nMemory leak in previous versions causes the memory for this script to blow up. <br>\r\n(uses multiple cores; relies on `add_features_variant_beds.sh`)\r\n\r\n#### Collapse site-level features created above into gene-level features\r\n```\r\nbash feature_construction/run_build_feature_count_summaries_all_genes.sh\r\n```\r\n(uses multiple cores; relies on :\r\n* `build_count_summaries_all_genes.sh`\r\n* `build_feature_summaries_all_genes.sh`\r\n* `build_feature_set.py`)\r\n\r\n#### Compile features for outliers and controls\r\n```\r\nbash feature_construction/run_compile_features_outliers.sh\r\n```\r\n(uses multiple cores; relies on:\r\n* `compile_features_outliers.sh`\r\n* `compile_features_outliers_nothresh.sh`\r\n* `compile_features_outliers_singletissue.sh`\r\n* `pick_outliers_controls_imbalanced.py`)\r\n\r\n## Disease gene annotations\r\nWe are providing the processed gene lists for the eight disease gene sets we analyzed for overlap with genes with multi-tissue outliers. <br>\r\nWe are also providing, where applicable, the commands and raw files needed to generate these processed lists.\r\n\r\n#### ACMG\r\nSource: http://www.ncbi.nlm.nih.gov/clinvar/docs/acmg/ <br>\r\nRaw file: `acmg.csv` <br>\r\nDownload from \\<website - coming soon\\>. <br>\r\nMove the downloaded file to `${RAREVARDIR}/features/annotations/ACMG/`.\r\n\r\n#### ClinVar\r\nSource: ftp://ftp.ncbi.nlm.nih.gov/pub/clinvar/gene_condition_source_id <br>\r\nRaw file: `gene_condition_source_id` <br>\r\nDownload from \\<website - coming soon\\>. <br>\r\nMove the downloaded file to `${RAREVARDIR}/features/annotations/ClinVar/`.\r\n\r\n#### GWAS\r\nSource: http://www.ebi.ac.uk/gwas/ <br>\r\nRaw file: `gwas_catalog_v1.0-downloaded_2015-11-30.tsv` <br>\r\nDownload from \\<website - coming soon\\>. <br>\r\nMove the downloaded file to `${RAREVARDIR}/features/annotations/GWAS/`.\r\n\r\n#### OMIM\r\nSource: http://www.omim.org/ <br>\r\nRaw files: `morbidmap.txt` and `mim2gene.txt` <br>\r\nProcessed file: `omim.genes.txt`\r\nDownlaod the raw and processed files from \\<website - coming soon\\>. <br>\r\nMove these files to `${RAREVARDIR}/features/annotations/OMIM/`.\r\n\r\nTo produce the processed file from the raw files: <br>\r\n```\r\ngrep '(3)' ${RAREVARDIR}/features/annotations/OMIM/morbidmap.txt | cut -f2 | sed 's/, /\\n/g' | sort | uniq > ${RAREVARDIR}/features/annotations/OMIM/omim.genes.temp.txt\r\n\r\ngrep -wf ${RAREVARDIR}/features/annotations/OMIM/omim.genes.temp.txt ${RAREVARDIR}/features/annotations/OMIM/mim2gene.txt  > ${RAREVARDIR}/features/annotations/OMIM/temp.mim2gene.intersection.txt\r\n\r\ncut -f4,5 ${RAREVARDIR}/features/annotations/OMIM/temp.mim2gene.intersection.txt | sort | uniq > ${RAREVARDIR}/features/annotations/OMIM/omim.genes.txt\r\n\r\nrm ${RAREVARDIR}/features/annotations/OMIM/omim.genes.temp.txt ${RAREVARDIR}/features/annotations/OMIM/temp.mim2gene.intersection.txt\r\n```\r\n\r\n#### Orphanet\r\nSource: http://www.orphadata.org/data/xml/en_product6.xml <br>\r\nRaw file: `en_product6.xml` <br>\r\nProcessed file: `orphanet.genes.txt` <br>\r\nDownlaod the raw and processed files from \\<website - coming soon\\>. <br>\r\nMove these files to `${RAREVARDIR}/features/annotations/Orphanet/`.\r\n\r\nTo produce the processed file from the raw file: <br>\r\n```\r\ngrep ENSG ${RAREVARDIR}/features/annotations/Orphanet/en_product6.xml | sort | uniq | grep -o 'ENSG[0-9]*' > ${RAREVARDIR}/features/annotations/Orphanet/orphanet.genes.txt\r\n```\r\n\r\n#### Other: Cardiovascular and Cancer disease genes\r\nWe assessed overlap of genes with multi-tissue outliers with two expert curated disease gene lists: one for heritable cancer predisposition and one for heritable cardiovascular disease. See the methods section of our manuscript for more information. <br>\r\nRaw files: `cancer.genes.gold.standard.csv` (Cancer), `cardio.genes.gold.standard.csv` (Cardio) \r\nDownlaod the raw files from \\<website - coming soon\\>. <br>\r\nMove these files to `${RAREVARDIR}/features/annotations/Other/`.\r\n\r\n## Shared eQTLs defined by METASOFT\r\npython shared.eqtls/bf.metasoft.py --META ${RAREVARDIR}/data/metasoft/Metasoft_Output_v6p.txt \\\r\n    --TISS ${RAREVARDIR}/data/metasoft/Metasoft_tissue_order.txt \\\r\n    --OUT ${RAREVARDIR}/data/metasoft/gtex.metasoft.v6p.selected.txt\r\n\r\n\r\n## Main figures\r\n#### Figure 1\r\n```\r\nbash paper_figures/pick.cartoon.example.sh\r\nRscript paper_figures/figure1a.plot.cartoon.example.R\r\nRscript paper_figures/figure1b.outlier.sharing.R\r\nRscript paper_figures/figure1c.replication.rate.consistent.R\r\n```\r\n\r\n#### Figure 2\r\n```\r\nbash paper_figures/count_rarevars.sh\r\nRscript paper_figures/figure2a.count.enrichments.R\r\nRscript paper_figures/figure2b.threshold.enrichments.R\r\nRscript paper_figures/figure2c.ASE.enrichments.R\r\nRscript paper_figures/figure2.R\r\n```\r\n\r\n#### Figure 3\r\n```\r\nRscript paper_figures/figure3a.rare.variant.class.enrichments.R\r\nRscript paper_figures/figure3b.feature.enrichments.R\r\nRscript paper_figures/figure3de.outlier.effect.size.R\r\nRscript paper_figures/figure3.R\r\n```\r\n\r\n#### Figure 4\r\n```\r\nRscript paper_figures/figure4a.uk10k.R\r\nRscript paper_figures/figure4b.exac.enrichments.R\r\nRscript paper_figures/figure4c.gene.list.enrichments.R\r\nRscript paper_figures/figure4.R\r\n```\r\n\r\n#### Figure 5\r\n```\r\nRscript getPosteriorsEval.R data/genomic_features.txt data/outliers.txt\r\nRscript paper_figures/figure5b.R\r\nRscript getPosteriorsApp.R data/genomic_features.txt data/outliers.txt data/postprobs_all.txt\r\nRscript paper_figures/figure5c.R\r\n```\r\n\r\n## Supplemental figures\r\n\r\n#### Number of rare variants per individual and PCA\r\nYou need to set the path to the downloaded expression covariates and subject annotations in the script below. <br> \r\n```\r\nRscript paper_figures/suppfig.number.rare.vars.pca.R\r\n```\r\n\r\n#### Improvement of replication of outliers across tissues by PEER correction\r\n```\r\nRscript paper_figures/ExtendedDataFigure3.R\r\n```\r\n\r\n#### Distribution of the nubmer of genes with an multi-tissue outlier\r\nYou need to set the path to the subject annotations in the script below. <br> \r\n```\r\nRscript paper_figures/suppfig.number.outliers.per.individual.R\r\n```\r\n\r\n#### Single-tissue replication analysis controlling for sampling differences\r\nGenerated when running 'paper_figures/figure1b.outlier.sharing.R' above\r\n\r\n#### Overlap between single and multi-tissue outliers\r\n```\r\nRscript paper_figures/suppfig.compare.single.multi.R\r\n```\r\n\r\n#### Single-tissue outlier rare variant enrichments\r\nGenerated when running `paper_figures/figure2b.threshold.enrichments.R` above\r\n\r\n#### Multi-tissue outlier rare variant enrichments when excluding coding regions\r\nGenerated when running `paper_figures/figure2a.count.enrichments.R above`\r\n\r\n#### Enrichment of functional genomic annotations among an expanded set of multi-tissue outliers\r\n```\r\nRscript paper_figures/ExtendedDataFigure9.R\r\n```\r\n\r\n#### Association between ASE and RIVER scores\r\n```\r\nRscript paper_figures/ExtendedDataFigure11.R\r\n```\r\n\r\n#### Correlation between test posterior probabilities and the fraction of tissues\r\n```\r\nRscript paper_figures/main_RIVER_10CV.R\r\nRscript paper_figures/ExtendedDataFigure12.R\r\n```\r\n\r\n#### Distribution of predictive scores for pathogenic variants and all variants\r\n```\r\nRscript paper_figures/ExtendedDataFigure13.R\r\n```\r\n\r\n#### Expression levels for genes proximal to pathogenic variants\r\n```\r\nRscript paper_figures/ExtendedDataFigure14.rpkm.R\r\nRscript paper_figures/ExtendedDataFigure14.Zscores.R\r\n```\r\n\r\n",
  "note": "Don't delete this file! It's used internally to help with page regeneration."
}