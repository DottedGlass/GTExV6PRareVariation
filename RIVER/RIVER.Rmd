---
title: "RIVER"
output: html_notebook
---

Sample data

```{r}
library("RIVER")
filename <- system.file("extdata", "simulation_RIVER.gz", 
                       package="RIVER")
dataInput <- getData(filename) # import experimental data

Feat <- t(Biobase::exprs(dataInput)) # genomic features (G)
Out <- as.numeric(unlist(dataInput$Outlier))-1 # outlier status (E)

head(Feat)
head(Out)

evaROC <- evaRIVER(dataInput)
cat('AUC (GAM-genomic annotation model) = ', round(evaROC$GAM_auc,3), '\n')
cat('AUC (RIVER) = ', round(evaROC$RIVER_auc,3), '\n')

par(mar=c(6.1, 6.1, 4.1, 4.1))
plot(NULL, xlim=c(0,1), ylim=c(0,1), 
     xlab="False positive rate", ylab="True positive rate", 
     cex.axis=1.3, cex.lab=1.6)
abline(0, 1, col="gray")
lines(1-evaROC$RIVER_spec, evaROC$RIVER_sens, 
      type="s", col='dodgerblue', lwd=2)
lines(1-evaROC$GAM_spec, evaROC$GAM_sens, 
      type="s", col='mediumpurple', lwd=2)
legend(0.7,0.2,c("RIVER","GAM"), lty=c(1,1), lwd=c(2,2),
       col=c("dodgerblue","mediumpurple"), cex=1.2, 
       pt.cex=1.2, bty="n")
title(main=paste("AUC: RIVER = ", round(evaROC$RIVER_auc,3), 
                 ", GAM = ", round(evaROC$GAM_auc,3), 
                 ", P = ", format.pval(evaROC$pvalue, digits=2, 
                                       eps=0.001),sep=""))
```


# Load libraries and file names
```{r}
require(RIVER)
require(dplyr)
require(tidyr)
require(data.table)
require(ggplot2)

# file names
euro_data_all <- "/scratch/groups/abattle4/victor/GTExV6PRareVariationData/data/RIVER/river_input_v8_european_all_05-21-2020.txt"
euro_data_common <- "/scratch/groups/abattle4/victor/GTExV6PRareVariationData/data/RIVER/river_input_v8_european_common_05-21-2020.txt"
afr_data_all <- "/scratch/groups/abattle4/victor/GTExV6PRareVariationData/data/RIVER/river_input_v8_african_all_05-21-2020.txt"
afr_data_common <- "/scratch/groups/abattle4/victor/GTExV6PRareVariationData/data/RIVER/river_input_v8_african_common_05-21-2020.txt"

```

# Prepare European data
```{r}
# european data
euro_df <- read.table('/work-zfs/abattle4/bstrober/rare_variant/gtex_v8/splicing/unsupervised_modeling/unsupervised_learning_input/fully_observed_merged_outliers_0.01_genes_intersection_between_te_ase_splicing_features_filter_no_tissue_anno_N2_pairs_3.txt', header=TRUE)

## rename columns
euro_df <- euro_df %>% rename(SubjectID = SubjectID, GeneName = GeneName, GC = gc, CpG = cpg, bStatistic = bstatistic, priPhCons = priphcons, mamPhCons = mamphcons, verPhCons = verphcons, priPhyloP = priphylop, mamPhyloP = mamphylop, verPhyloP = verphylop, GerpN = gerpn, GerpS = gerps, PHRED = phred, SIFTcat_deleterious = siftcat_deleterious, SIFTcat_tolerated = siftcat_tolerated, SIFTval = siftval, PolyPhenCat_benign = polyphencat_benign, PolyPhenCat_possibly_damaging = polyphencat_possibly_damaging, PolyPhenCat_probably_damaging = polyphencat_probably_damaging, PolyPhenCat_unknown = polyphencat_unknown, PolyPhenVal = polyphenval, dist_to_tss = distTSS, N2pair = N2pair)


## get z-scores
euro_df <- euro_df %>% mutate(Zscore = qnorm(abs(total_expression_pvalue)/2)*sign(total_expression_pvalue))

## format columns
euro_df <- select(euro_df,-contains("pvalue")) # drop columns containing "pvalue"
euro_df <- euro_df %>% select(-N2pair,N2pair) # move N2pair column to last column

## save version that keeps all features
write.table(x = euro_df, row.names = FALSE, quote = FALSE, file = euro_data_all)

## keep features that are common between european and african data
euro_df <- euro_df %>% select(SubjectID, GeneName, GC, CpG, bStatistic, priPhCons, mamPhCons, verPhCons, priPhyloP, mamPhyloP, verPhyloP, GerpN, GerpS, PHRED, SIFTcat_deleterious, SIFTcat_tolerated, SIFTval, PolyPhenCat_benign, PolyPhenCat_possibly_damaging, PolyPhenCat_probably_damaging, PolyPhenCat_unknown, PolyPhenVal, dist_to_tss, Zscore,  N2pair)

## save version with common features
write.table(x = euro_df, row.names = FALSE, quote = FALSE, file = euro_data_common)
```

# Prepare African data
```{r}
# african data
afr_df <- read.table('/work-zfs/abattle4/bstrober/random_projects/feature_generation_for_victor_and_jessica/river_input_gene_level.txt', header=TRUE)

## get zscores
z_scores <- read.table('/scratch/groups/abattle4/victor/GTExV6PRareVariationData/archive/data/v8/outliers_medz_zscores.txt', header=TRUE, check.names = FALSE)

zscore_table <- z_scores %>% gather(key="SubjectID",value="Zscore",-GENE) %>% rename(GeneName=GENE)
zscore_table <- as.data.table(zscore_table)
setkey(zscore_table,GeneName,SubjectID)

zscore_list <- vector("numeric",nrow(afr_df))
for (i in seq(nrow(afr_df))) {
  subject <- as.character(afr_df[i,1])
  gene <- as.character(afr_df[i,2])
  zscore_list[i] <- zscore_table[.(gene,subject)]$Zscore
}


# add zscores to afr_df
afr_df$Zscore <- zscore_list

## format columns
afr_df <- afr_df %>% select(-N2pair,N2pair) # move N2pair column to last column

# drop rows with NA in zscores
afr_df <- afr_df[complete.cases(zscore_list), ]

# save version that keeps all features
write.table(x = afr_df, row.names = FALSE, quote = FALSE, file = afr_data_all)

# keep features that are common between european and african data
afr_df <- afr_df %>% select(SubjectID, GeneName, GC, CpG, bStatistic, priPhCons, mamPhCons, verPhCons, priPhyloP, mamPhyloP, verPhyloP, GerpN, GerpS, PHRED, SIFTcat_deleterious, SIFTcat_tolerated, SIFTval, PolyPhenCat_benign, PolyPhenCat_possibly_damaging, PolyPhenCat_probably_damaging, PolyPhenCat_unknown, PolyPhenVal, dist_to_tss, Zscore,  N2pair)

# save version with common features
write.table(x = afr_df, row.names = FALSE, quote = FALSE, file = afr_data_common)

```

```{r load_plotfunc, eval=FALSE}
plot_RIVER_GAM <- function(evaOutput, top_title=NULL){
RIVER_plotdata <- data.frame(spec=evaOutput$RIVER_spec,sens=evaOutput$RIVER_sens)
GAM_plotdata <- data.frame(spec=evaOutput$GAM_spec,sens=evaOutput$GAM_sens)
subtitle_text=paste("AUC: RIVER = ",round(evaOutput$RIVER_auc,3), 
                 ", GAM = ", round(evaOutput$GAM_auc,3), 
                 ", P = ", format.pval(evaOutput$pvalue, digits=2, 
                                       eps=0.001),sep="")

g <- ggplot() +
  geom_line(aes(color="GAM",x=1-spec,y=sens),data=GAM_plotdata) +
  geom_line(aes(color="RIVER",x=1-spec,y=sens),data=RIVER_plotdata) +
  xlab("False Positive Rate") +
  ylab('True Positive Rate') +
  geom_abline(color="grey",slope = 1,intercept = 0) +
  ggtitle(label = top_title,subtitle = subtitle_text) +
  labs(colour = "Model")
return(g)
}

```

# Evaluate RIVER on European data with all features 
```{r}
dataInput_euro_all <- getData(euro_data_all)
evaROC_euro_all <- evaRIVER(dataInput_euro_all)
cat('AUC (GAM-genomic annotation model) = ', round(evaROC_euro_all$GAM_auc,3), '\n')
cat('AUC (RIVER) = ', round(evaROC_euro_all$RIVER_auc,3), '\n')

plot_RIVER_GAM(evaROC_euro_all,top_title="European All Features")ßß

outfile_evaROC_euro_all <- "/scratch/groups/abattle4/victor/GTExV6PRareVariationData/data/RIVER/river_evaROC_v8_european_all_05-21-2020.RData"
save(evaROC_euro_all, file = outfile_evaROC_euro_all)

```

# Run RIVER on European data with all features 
```{r}
model_euro_all <- appRIVER(dataInput_euro_all, pseudoc=50, 
                      theta_init=matrix(c(.99, .01, .3, .7), nrow=2), 
                      costs=c(100, 10, 1, .1, .01, 1e-3, 1e-4), 
                      verbose=TRUE)

outfile_model_euro_all <- "/scratch/groups/abattle4/victor/GTExV6PRareVariationData/data/RIVER/river_model_european_all_05-21-2020.RData"
save(model_euro_all, file = outfile_model_euro_all)
```

# Evaluate RIVER on European data with common features
```{r}
dataInput_euro_common <- getData(euro_data_common)
evaROC_euro_common <- evaRIVER(dataInput_euro_common)
cat('AUC (GAM-genomic annotation model) = ', round(evaROC_euro_common$GAM_auc,3), '\n')
cat('AUC (RIVER) = ', round(evaROC_euro_common$RIVER_auc,3), '\n')

plot_RIVER_GAM(evaROC_euro_common,top_title="European Common Features")

outfile_evaROC_euro_common <- "/scratch/groups/abattle4/victor/GTExV6PRareVariationData/data/RIVER/river_evaROC_v8_european_common_05-21-2020.RData"
save(evaROC_euro_common, file = outfile_evaROC_euro_common)

```

# Run RIVER on European data with common features
```{r}
model_euro_common <- appRIVER(dataInput_euro_common, pseudoc=50, 
                      theta_init=matrix(c(.99, .01, .3, .7), nrow=2), 
                      costs=c(100, 10, 1, .1, .01, 1e-3, 1e-4), 
                      verbose=TRUE)

outfile_model_euro_common <- "/scratch/groups/abattle4/victor/GTExV6PRareVariationData/data/RIVER/river_model_european_common_05-21-2020.RData"
save(model_euro_common, file = outfile_model_euro_common)
```


# Evaluate RIVER on African data with all features
```{r}
dataInput_afr_all <- getData(afr_data_all)
evaROC_afr_all <- evaRIVER(dataInput_afr_all)
cat('AUC (GAM-genomic annotation model) = ', round(evaROC_afr_all$GAM_auc,3), '\n')
cat('AUC (RIVER) = ', round(evaROC_afr_all$RIVER_auc,3), '\n')

plot_RIVER_GAM(evaROC_afr_all,top_title="African All Features")

outfile_evaROC_afr_all <- "/scratch/groups/abattle4/victor/GTExV6PRareVariationData/data/RIVER/river_evaROC_v8_african_all_05-21-2020.RData"
save(evaROC_afr_all, file = outfile_evaROC_afr_all)
```

# Run RIVER on African data with all features
```{r}
model_afr_all <- appRIVER(dataInput_afr_all, pseudoc=50, 
                      theta_init=matrix(c(.99, .01, .3, .7), nrow=2), 
                      costs=c(100, 10, 1, .1, .01, 1e-3, 1e-4), 
                      verbose=TRUE)

outfile_model_afr_all <- "/scratch/groups/abattle4/victor/GTExV6PRareVariationData/data/RIVER/river_model_african_all_05-21-2020.RData"
save(model_afr_all, file = outfile_model_afr_all)
```

# Evaluate RIVER on African data with common features
```{r}
dataInput_afr_common <- getData(afr_data_common)
evaROC_afr_common <- evaRIVER(dataInput_afr_common)
cat('AUC (GAM-genomic annotation model) = ', round(evaROC_afr_common$GAM_auc,3), '\n')
cat('AUC (RIVER) = ', round(evaROC_afr_common$RIVER_auc,3), '\n')

plot_RIVER_GAM(evaROC_afr_common, top_title="African Common Features")

outfile_evaROC_afr_common <- "/scratch/groups/abattle4/victor/GTExV6PRareVariationData/data/RIVER/river_evaROC_v8_african_common_05-21-2020.RData"
save(evaROC_afr_common, file = outfile_evaROC_afr_common)
```

# Run RIVER on African data with common features
```{r}
model_afr_common <- appRIVER(dataInput_afr_common, pseudoc=50, 
                      theta_init=matrix(c(.99, .01, .3, .7), nrow=2), 
                      costs=c(100, 10, 1, .1, .01, 1e-3, 1e-4), 
                      verbose=TRUE)

outfile_model_afr_common <- "/scratch/groups/abattle4/victor/GTExV6PRareVariationData/data/RIVER/river_model_african_common_05-21-2020.RData"
save(model_afr_common, file = outfile_model_afr_common)
```

# plot posterior scores
```{r}
# European all features
plotPosteriors(model_euro_all, outliers=as.numeric(unlist(dataInput_euro_all$Outlier))-1)

# European common features
plotPosteriors(model_euro_common, outliers=as.numeric(unlist(dataInput_euro_common$Outlier))-1)

# African all features
plotPosteriors(model_afr_all, outliers=as.numeric(unlist(dataInput_afr_all$Outlier))-1)

# African common features
plotPosteriors(model_afr_common, outliers=as.numeric(unlist(dataInput_afr_common$Outlier))-1)
```

# Save plots of evaluation
```{r}
# pdf("/scratch/groups/abattle4/victor/GTExV6PRareVariationData/paper_figures/RIVER_European_all.pdf", width = 7, height = 7)
# plot_RIVER_GAM(evaROC_euro_all,top_title="European All Features")
# dev.off()
# plot_RIVER_GAM(evaROC_euro_common,top_title="European Common Features")
# plot_RIVER_GAM(evaROC_afr_all,top_title="African All Features")
# plot_RIVER_GAM(evaROC_afr_common, top_title="African Common Features")


```

# make dataframe to compare European and African outliers, watershed posterior > 0.5, and watershed posterior > 0.9
```{r}
# read outlier files
euro_outlier <- read.table("/scratch/groups/abattle4/victor/GTExV6PRareVariationData/archive/data/v8/outliers_medz_picked_counts_per_ind_EUR.txt", header = FALSE, col.names = c("indiv","num_outliers"))
euro_outlier$ethnicity <- "European"

afr_outlier <- read.table("/scratch/groups/abattle4/victor/GTExV6PRareVariationData/archive/data/v8/outliers_medz_picked_counts_per_ind_AFA.txt", header = FALSE, col.names = c("indiv","num_outliers"))
afr_outlier$ethnicity <- "African American"


# read RIVER models trained on common features
load(outfile_model_euro_common)
load(outfile_model_afr_common)

# make dataframes for posterior
euro_posterior <- data.frame(indiv=model_euro_common$indiv_name, greater_0.5=model_euro_common$RIVER_posterior>0.5, greater_0.9=model_euro_common$RIVER_posterior>0.9)

afr_posterior <- data.frame(indiv=model_afr_common$indiv_name, greater_0.5=model_afr_common$RIVER_posterior>0.5, greater_0.9=model_afr_common$RIVER_posterior>0.9)

euro_posterior <- euro_posterior %>% group_by(indiv) %>% summarize(count_0.5 = sum(greater_0.5), count_0.9 = sum(greater_0.9))
euro_posterior$ethnicity <- "European"

afr_posterior <- afr_posterior %>% group_by(indiv) %>% summarize(count_0.5 = sum(greater_0.5), count_0.9 = sum(greater_0.9))
afr_posterior$ethnicity <- "African American"

# combine posterior dataframes
posterior <- rbind(euro_posterior, afr_posterior)
posterior <- posterior %>% gather(key=key,value=value,-indiv,-ethnicity)
posterior$type <- "RIVER"

# combine outlier dataframes
outlier <- rbind(euro_outlier, afr_outlier)
outlier <- outlier %>% gather(key=key, value=value, -indiv, -ethnicity)
outlier$type <- "outlier"

# # combine outlier and posterior dataframes
# box_plot_input <- rbind(outlier, posterior)
# 
# ggplot(box_plot_input) + geom_boxplot(aes(x=key,y=value,col=ethnicity)) + facet_wrap(type~.)

# outlier boxplot
ggplot(outlier) + geom_boxplot(aes(x=key,y=value,col=ethnicity))

# RIVER histograms
# ggplot(posterior) + geom_boxplot(aes(x=key,y=value,col=ethnicity))
posterior %>% filter(key=="count_0.5") %>% ggplot() + geom_histogram(aes(x=value, fill=ethnicity), binwidth = 1, position = "identity") + scale_x_continuous(breaks= scales::pretty_breaks())

ggplot(euro_posterior) + geom_histogram(aes(x=count_0.5))
```
