---
title: "R Notebook"
output:
  html_document:
    pairs_df_print: paged
---


```{r}
library(tidyr)
library(data.table)

# files needed
z_scores_file <- '/scratch/groups/abattle4/victor/GTExV6PRareVariationData/archive/data/v8/outliers_medz_zscores.txt'
rare_var_pairs_file <- '/scratch/groups/abattle4/victor/GTExV6PRareVariationData/archive/reference/gene_indiv_variants.txt'
afr_indiv_file <- '/scratch/groups/abattle4/victor/GTExV8_RareVariationData/reference/gtex_v8_wgs_individuals_AFA.txt'

# read in files needed
z_scores <- read.table(z_scores_file, header=TRUE, check.names = FALSE) # wide table with z scores for gene-individual pairs
rare_var_pairs <- read.table(rare_var_pairs_file, header=TRUE, check.names = FALSE) # table of gene-individual pairs with their rare variants
afr_indiv <- as.character(read.table(afr_indiv_file)$V1) # list of African American individuals with WGS

# convert to long table with three columns: gene, individual, zscore
gene_list <- colnames(z_scores)[-1]
pairs_df <- gather_(z_scores, key="indiv", value="zscore", gene_list)

# remove gene-individuals with NA zscores
pairs_df <- drop_na(pairs_df, zscore)

# filter for African individuals only
# pairs_df <- pairs_df %>% filter(indiv %in% afr_indiv)
pairs_df <- filter(pairs_df, (indiv %in% afr_indiv))

# add column to pairs_df which indicates if the given gene-individual pair has at least 1 rare variant within 10kb of gene TSS
rare_var_pairs$easykey <- paste0(rare_var_pairs$gene,rare_var_pairs$indiv)
pairs_df$easykey <- paste0(pairs_df$gene,pairs_df$indiv)
pairs_df$has_rare <- ifelse(pairs_df$easykey %in% rare_var_pairs$easykey,1,0)

# compute enrichment
zscore_thresh_list <- seq(1,10)
for (thresh in zscore_thresh_list) {
  pairs_df[[paste0("outlier_status_at_thresh_",thresh)]] <- ifelse(pairs_df$z_score > thresh, "outlier","inlier")
}

# build frequency table to count inliers and outliers with or without rare variants
count_table <-
    pairs_df %>% 
    gather(contains("thresh"), key=thresh,value=outlier) # make a longer table %>% 
    group_by(thresh) %>%
    count(outlier) %>%
    pivot_wider(names_from=outlier,values_from=n) %>% 
    rename(outlier_all_pairs=outlier, inlier_all_pairs=inlier)

# build frequency table to count inliers and outliers (with  rare variants)
rare_count_table <- 
    pairs_df %>%
    filter(has_rare == 1) %>%
    gather(contains("thresh"), key=thresh,value=outlier) # make a longer table %>%
    group_by(thresh) %>%
    count(outlier) %>%
    pivot_wider(names_from=outlier,values_from=n) %>% 
    rename(outlier_rare_pairs=outlier, inlier_rare_pairs=inlier) 

enrichment.df  <- merge(count_table,rare_count_table,by="thresh",all=T) %>% mutate(numerator=outlier_rare_pairs/outlier_all_pairs, denominator=inlier_rare_pairs/inlier_all_pairs, enrichment=numerator/denominator)


calc_enrichment <- function(pairs_df, outlier_status) {
  # compute numerator - ratio of # of outlier Afr gene-indiv with nearby rare variant to # of outlier Afr gene-indiv pairs
  # subet pairs_df for outliers
  pairs_df_outliers <- pairs_df[outlier_status,]
    
  # compute denominator - ratio of # of inlier Afr gene-indiv with nearby rare variant to # of inlier Afr gene-indiv pairs
  
}


```
