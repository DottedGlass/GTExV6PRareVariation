---
title: "R Notebook"
output:
  html_document:
    pairs.df_print: paged
---


```{r}
library(tidyr)
library(dplyr)
library(data.table)
library(ggplot2)

# files needed
z_scores_file <- '/scratch/groups/abattle4/victor/GTExV6PRareVariationData/archive/data/v8/outliers_medz_zscores.txt'
rare_var_pairs_file <- '/scratch/groups/abattle4/victor/GTExV6PRareVariationData/archive/reference/gene_indiv_variants.txt'
afr_indiv_file <- '/scratch/groups/abattle4/victor/GTExV8_RareVariationData/reference/gtex_v8_wgs_individuals_AFA.txt'

# read in files needed
z_scores <- read.table(z_scores_file, header=TRUE, check.names = FALSE) # wide table with z scores for gene-individual pairs
rare_var_pairs <- read.table(rare_var_pairs_file, header=TRUE, check.names = FALSE) # table of gene-individual pairs with their rare variants
afr_indiv <- as.character(read.table(afr_indiv_file)$V1) # list of African American individuals with WGS

# convert to long table with three columns: gene, individual, zscore
gene_list <- colnames(z_scores)[-1]
pairs.df <- gather_(z_scores, key="indiv", value="zscore", gene_list)

# remove gene-individuals with NA zscores
pairs.df <- drop_na(pairs.df, zscore)

# filter for African individuals only
pairs.df <- filter(pairs.df, (indiv %in% afr_indiv))

# add column to pairs.df which indicates if the given gene-individual pair has at least 1 rare variant within 10kb of gene TSS
rare_var_pairs$easykey <- paste0(rare_var_pairs$gene,rare_var_pairs$individual)
pairs.df$easykey <- paste0(pairs.df$GENE,pairs.df$indiv)
pairs.df$has_rare <- ifelse(pairs.df$easykey %in% rare_var_pairs$easykey,1,0)

# compute enrichment
zscore_thresh_list <- seq(1,5, 0.5)
for (thresh in zscore_thresh_list) {
  pairs.df[[paste0("outlier_status_at_thresh_",thresh)]] <- ifelse(pairs.df$zscore > thresh, "outlier","inlier")
}

# build frequency table to count inliers and outliers with or without rare variants
count_table <-
    pairs.df %>% 
    gather(contains("thresh"), key=thresh,value=outlier) %>% # make table longer 
    group_by(thresh) %>%
    count(outlier) %>%
    pivot_wider(names_from=outlier,values_from=n) %>% 
    rename(outlier_all_pairs=outlier, inlier_all_pairs=inlier)

# build frequency table to count inliers and outliers (with  rare variants)
rare_count_table <- 
    pairs.df %>%
    filter(has_rare == 1) %>%
    gather(contains("thresh"), key=thresh,value=outlier) %>% # make a longer table
    group_by(thresh) %>%
    count(outlier) %>%
    pivot_wider(names_from=outlier,values_from=n) %>% 
    rename(outlier_rare_pairs=outlier, inlier_rare_pairs=inlier) 

enrichment.df  <- merge(count_table,rare_count_table,by="thresh",all=T) %>% mutate(numerator=outlier_rare_pairs/outlier_all_pairs, denominator=inlier_rare_pairs/inlier_all_pairs, enrichment=numerator/denominator)

# confidence intervals
enrichment.df <- enrichment.df %>% mutate(log_se = sqrt(1/outlier_rare_pairs - 1/outlier_all_pairs + 1/inlier_rare_pairs - 1/inlier_all_pairs), lower_CI = enrichment * exp(-1.96*log_se), upper_CI = enrichment * exp(1.96*log_se))


# sorting rows by z score threshold
enrichment.df$sortcol <- as.numeric(gsub("outlier_status_at_thresh_", "", enrichment.df$thresh))
enrichment.df <- arrange(enrichment.df, sortcol)

enrichment_plot <- ggplot(enrichment.df, aes(x = sortcol, y = enrichment)) +
  geom_point(size = 2) + 
  geom_errorbar(aes(ymax = upper_CI, ymin = lower_CI))
print(enrichment_plot + labs(x = "Z-score threshold"))


```
